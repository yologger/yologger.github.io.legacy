
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yologger&#39;s Blog">
    <title>[결제(Payment)] (4) 인앱 결제(Google Play Billing API) - 정기 결제(구독) - Yologger&#39;s Blog</title>
    <meta name="author" content="yologger">
    
    
        <link rel="icon" href="https://yologger.github.io/ko/assets/images/favicon.png">
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"yologger","sameAs":[]},"articleBody":"\n들어가며여섯 개의 포스트에 걸쳐서 안드로이드 앱의 결제 방식에 대해 알아보고있습니다.\n\n개요\n인앱 결제(Google Play Billing API) - 소모품\n인앱 결제(Google Play Billing API) - 비소모품\n인앱 결제(Google Play Billing API) - 정기 결제(구독)\nVAN, PG, 간편 결제의 차이점\nPG 결제 구현하기(아임포트)\n\n\n디지털 제품구글 결제 API(Google Play Billing API)를 사용하면 디지털 제품을 판매할 수 있습니다. 디지털 제품에는 두 종류가 있습니다.\n(1) 일회성 제품일회성 제품(One-time product)은 사용자가 한번만 결제하여 구매할 수 있는 제품입니다. 일회성 제품에는 두 종류가 있습니다.\n\n소모품: 게임 머니, 게임 화폐 같이 소비할 수 있는 제품입니다. 제품은 소비하면 다시 구매할 수 있습니다.\n비소모품: 한 번 구매하면 영구적으로 사용할 수 있는 제품입니다. 예를 들어 광고 제거, 프리미엄 버전 업그레이드가 있습니다.\n\n(2) 정기 결제(구독)정기 결제(구독)는 반복적으로 청구되는 제품입니다. 유튜브 프리미엄, 음악 스트리밍 서비스, 뉴스 구독이 대표적인 정기 결제입니다. 정기 결제는 사용자가 직접 취소할 때까지 자동으로 갱신 및 결제됩니다.\n\n정기 결제(구독) 구현하기다음과 같은 앱을 만들면서 정기 결제(구독)를 구현해보겠습니다.\n(1) 개발자 계정 생성앱을 테스트하거나 구글 플레이스토어에 출시하려면 구글 개발자 계정을 만들어야 합니다. 이 곳에 방문하여 구글 개발자 계정을 생성합니다. (현재는 미화로 25달러를 결제해야하며, 한번 결제 시 평생 이용할 수 있습니다.)\n(2) 결제 프로필 작성이전에 작성한 적이 없다면 결제 프로필을 새롭게 작성해야합니다. 왼쪽 사이드바 메뉴 &gt; Setup &gt; Payment profile로 이동하여 Create payments profile을 클릭합니다.다음 항목이 제대로 입력되어있는지 확인합니다.\n\nAccount type: 계정 유형입니다. 개인과 기업으로 구분됩니다.\nTax information: 세금 정보입니다. 개인 사업자와 법인 사업자로 구분됩니다.\nName and address: 사업장 이름과 주소입니다.\n\n\n\nBusiness name: 사업장 이름 입니다.\nWebsite: 사업장 웹 사이트입니다.\nWhat do you sell: 판매할 상품입니다.\nCustomer support email: 고객 지원 메일입니다.\nCredit card statement name: 신용카드 명세서 이름입니다.\n\n(3) 구글 플레이 콘솔에 앱 생성하기구글 플레이 콘솔 &gt; All apps &gt; Create app을 선택합니다.\nApp details의 하위 항목을 입력합니다.\n\nApp name: 플레이 스토어에 출시되는 앱 이름\nDefault launguage: 기본 언어\nApp or game: 게임 앱인 경우 game, 그 외에는 App \nFree or paid: 무료 앱인 경우 free, 유료 앱인 경우 paid\n\nDeclarations의 하위 항목을 모두 체크합니다.\n\nDeveloper Program Policies: 개발자 프로그램 정책에 동의\nUS export laws: 미국 수출법규에 동의\n\n구글 플레이 콘솔 &gt; All apps을 선택하면 생성한 앱을 확인할 수 있습니다.\n(4) 의존성 설정안드로이드 스튜디오에서 새로운 프로젝트를 생성하고 모듈 수준의 build.gradle에 의존성을 추가합니다.\n모듈 수준의 build.gradlegroovy123// Google Pay APIdef billing_version = \"4.0.0\"implementation \"com.android.billingclient:billing:$billing_version\"\n코틀린을 사용한다면 다음 의존성도 추가합니다.\n모듈 수준의 build.gradlegroovy1implementation \"com.android.billingclient:billing-ktx:$billing_version\"\n\n코루틴을 사용한다면 다음 의존성을 추가합니다.\n모듈 수준의 build.gradlegroovy12def lifecycle_version = '2.2.0' implementation \"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version\"\n\n(5) 권한 추가AndroidManifest.xml에 인터넷 권한과 결제 권한을 추가합니다.\nAndroidManifest.xmlxml12345678&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"    package=\"com.yologger.inapp_payment_consumable_product\"&gt;    &lt;uses-permission android:name=\"android.permission.INTERNET\"/&gt;    &lt;uses-permission android:name=\"com.android.vending.BILLING\"/&gt;&lt;/manifest&gt;\n\n(6) APK 파일 업로드앱에서 판매할 상품은 구글 플레이 콘솔의 Moentize &gt; Products &gt; Subscription에서 추가합니다. 그러나 APK 파일을 업로드하지 않으면 이 페이지가 활성화되지 않습니다.\n따라서 의존성과 권한만을 추가한 APK 파일을 업로드 하겠습니다. 실제 결제 로직은 다음 단계에서 구현합니다. \n구글 결제 API는 디버그 모드에서 테스트할 수 없습니다. 내부 테스트, 비공개 테스트, 공개 테스트, 정식 출시 중 어떤 형태로든 구글 플레이스토어에 출시가 되어야합니다. 이 포스트에서는 내부 테스트에 APK 파일을 업로드합니다.\n\n\n결제 테스트 시 구글 개발자 계정이 아닌 다른 구글 계정이 필요합니다. 구글 개발자 계정으로는 테스트할 수 없습니다.\n\n\nTesting &gt; Internal Testing으로 이동한 후 Create new release를 선택합니다.\n\nUpload를 클릭하고 APK 파일을 업로드합니다. 그리고 Save와 Review release를 순서대로 클릭합니다.\n(7) 판매할 상품 등록하기다시 구글 플레이 콘솔의 Moentize &gt; Products &gt; Subscriptions로 이동합니다. 이제 아이템을 추가할 수 있게 되었습니다. Create subscription 버튼을 클릭합니다.\n상품 정보를 입력합니다.\n\nProduct ID: 코드에서 판매 가능한 아이템을 조회할 때 사용하는 ID \nName: 판매할 상품의 이름\nDescription: 판매할 상품의 자세한 설명\n\n가격 정보를 입력합니다.\n\nBilling peroid: 결제 주기를 선택합니다.\nDefault price: 가격을 입력합니다.\n\n구독 옵션을 적절하게 선택합니다. 구독 옵션에서는 무료 체험판, 신규 할인 가격, 유예 기간, 재가입 여부를 선택할 수 있습니다.\nSave버튼을 눌러 저장합니다.Active버튼을 눌러 상품을 활성화합니다.상품이 정상적으로 추가되었습니다.\n(8) 라이선스 테스트에 계정 등록라이선스 테스트에 등록한 계정은 결제를 해도 실제로 청구가 이루어지지 않습니다. 또한 정기 결제(구독)의 경우 원래 결제 주기(1주, 한달, 분기, 1년 등)가 아니라 5분에 한번씩 가상으로만 청구됩니다.\nSetup &gt; License testing으로 이동하여 이메일을 추가하면 됩니다.\n라이선스 테스트에서 계정을 등록하지 않으면 구글 계정에 등록한 카드로 실제 결제됩니다.\n실제로 결제되면 구매자 Gmail 계정으로 영수증이 전송됩니다.\n만약 카드사에서 문자서비스를 신청했다면 결제 내역이 문자 메시지로 전송되기도 합니다.\nGoogle Play Console &gt; Order managerment에서 판매 내역을 확인할 수 있습니다.\n구독 제품(정기 결제)는 설정한 주기에 따라 결제되며, Order ID에 ..0, ..1, ..2처럼 숫자가 붙게됩니다.\n오른쪽 화살표를 누르면 상세한 구매 내역도 확인할 수 있으며, 환불도 가능합니다.\n(9) 레이아웃 디자인하기화면 레이아웃은 다음과 같습니다.\nactivity_main.xmlxml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"    xmlns:app=\"http://schemas.android.com/apk/res-auto\"    xmlns:tools=\"http://schemas.android.com/tools\"    android:layout_width=\"match_parent\"    android:layout_height=\"match_parent\"    android:orientation=\"vertical\"    tools:context=\".MainActivity\"&gt;    &lt;androidx.constraintlayout.widget.ConstraintLayout        android:id=\"@+id/activity_main_constraintLayout_ad\"        android:layout_width=\"match_parent\"        android:layout_height=\"100dp\"        android:background=\"#009688\"&gt;        &lt;TextView            android:layout_width=\"wrap_content\"            android:layout_height=\"wrap_content\"            android:text=\"This is advertisement\"            android:textColor=\"@color/white\"            app:layout_constraintTop_toTopOf=\"parent\"            app:layout_constraintBottom_toBottomOf=\"parent\"            app:layout_constraintStart_toStartOf=\"parent\"            app:layout_constraintEnd_toEndOf=\"parent\"&gt;        &lt;/TextView&gt;    &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;\\    &lt;androidx.constraintlayout.widget.ConstraintLayout        android:layout_width=\"match_parent\"        android:layout_height=\"0dp\"        android:layout_weight=\"1\"&gt;        &lt;LinearLayout            android:id=\"@+id/activity_main_linearlayout\"            android:layout_width=\"wrap_content\"            android:layout_height=\"wrap_content\"            android:orientation=\"horizontal\"            app:layout_constraintTop_toTopOf=\"parent\"            app:layout_constraintStart_toStartOf=\"parent\"            app:layout_constraintEnd_toEndOf=\"parent\"            app:layout_constraintBottom_toTopOf=\"@+id/activity_main_button_subscribe\"&gt;            &lt;TextView                android:id=\"@+id/activity_main_textView_title\"                android:layout_width=\"wrap_content\"                android:layout_height=\"wrap_content\"                android:text=\"MeTube\"                android:textSize=\"30sp\"                android:textStyle=\"bold\"                android:layout_margin=\"8dp\"/&gt;            &lt;TextView                android:id=\"@+id/activity_main_textView_version\"                android:layout_width=\"wrap_content\"                android:layout_height=\"wrap_content\"                android:text=\"Free\"                android:textSize=\"15sp\"                android:textStyle=\"bold\"/&gt;        &lt;/LinearLayout&gt;        &lt;Button            android:enabled=\"false\"            android:id=\"@+id/activity_main_button_subscribe\"            android:layout_width=\"wrap_content\"            android:layout_height=\"wrap_content\"            android:text=\"Subscribe\"            app:layout_constraintTop_toBottomOf=\"@+id/activity_main_linearlayout\"            app:layout_constraintStart_toStartOf=\"parent\"            app:layout_constraintEnd_toEndOf=\"parent\"            app:layout_constraintBottom_toBottomOf=\"parent\"/&gt;    &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;&lt;/LinearLayout&gt;\n\n\nMainActivity.ktkotlin1234567891011class MainActivity : AppCompatActivity() {    private val viewAdvertisement: ConstraintLayout by lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }    private val textViewVersion: TextView by lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }    private val buttonSubscribe: Button by lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)    }}\n\n(10) BillingManager 클래스 정의결제 관련 작업을 담당하는 BillingManager클래스를 정의하겠습니다. 또한 결제 관련 작업이 완료되었을 때 호출할 콜백을 인터페이스 형태로 정의합시다. BillingManager는 생성자의 인자로 액티비티와 콜백을 전달받습니다.\nBillingMananger.ktkotlin12345678910class BillingManager(    private val activity: Activity,    private val callback: Callback) {    interface Callback {        fun onBillingManagerReady()        fun onSuccess(purchase: Purchase)        fun onFailure(errorCode: Int)    }}\n\nonBillingManagerReady(): 결제 준비가 완료되었을 때 호출되는 메소드\nonSuccess(purchase: Purchase): 결제가 성공되었을 때 호출되는 메소드\nonFailure(errorCode: Int): 결제가 실패했을 때 호출되는 메소드\n\nMainActivity에서 BillingManager의 인스턴스를 생성합시다.\nMainActivity.ktkotlin12345678910111213141516171819202122232425262728293031class MainActivity : AppCompatActivity() {    private val viewAdvertisement: ConstraintLayout by lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }    private val textViewVersion: TextView by lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }    private val buttonSubscribe: Button by lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }    private lateinit var billingManager: BillingManager    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupBilling()    }    private fun setupBilling() {        billingManager = BillingManager(this, object : BillingManager.Callback {            override fun onBillingManagerReady() {                // ...            }            override fun onSuccess(purchase: Purchase) {                // ...            }            override fun onFailure(errorCode: Int) {                // ...            }        })    }}\n\n\n(11) BillingClient 객체 초기화구글 결제 API는 결제 관련 작업을 위해 BillingClient클래스를 제공합니다. BillingManager에서 클래스의 인스턴스를 생성합니다.\nBillingMananger.ktkotlin1234567891011121314class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    private val purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;        // ...    }    private val billingClient = BillingClient.newBuilder(activity)        .setListener(purchasesUpdatedListener)        .enablePendingPurchases()        .build()}\nBillingClient객체를 생성할 때 setListener()함수에 PurchasesUpdatedListener의 구현체를 전달합니다. 이 구현체의 메소드는 결제를 요청한 후 호출됩니다. 이 메소드 안에서 결제 성공여부를 확인할 수 있습니다.\nBillingMananger.ktkotlin123456789101112131415161718class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    private val purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != null) {            // 구매 성공 시        } else {            // 구매 실패 시        }    }    private val billingClient = BillingClient.newBuilder(activity)        .setListener(purchasesUpdatedListener)        .enablePendingPurchases()        .build()}\n\n\n(12) 앱과 Google Play 연결하기이제 앱과 Google Play를 연결해야합니다. BillingClient클래스의 startConnection()을 호출하면 됩니다. BillingMananger클래스의 인스턴스를 생성할 때 가장 먼저 호출되는 init구문에서 이 메소드를 호출합시다.\nBillingMananger.ktkotlin12345678910111213141516171819202122232425262728class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    init {        billingClient.startConnection(object : BillingClientStateListener {            override fun onBillingSetupFinished(billingResult: BillingResult) {                when (billingResult.responseCode) {                    BillingClient.BillingResponseCode.OK -&gt; {                        // Google Play와의 연결이 성공했을 때                        callback.onBillingManagerReady()                    }                    else -&gt; {                        // Google Play와의 연결이 실패했을 때                        callback.onFailure(billingResult.responseCode)                    }                }            }            override fun onBillingServiceDisconnected() {                // Google Play와 연결이 끊어졌을 때 재시도하는 로직            }        })    }}\n\nonBillingSetupFinished(): 앱과 Google Play의 연결되었을 때 호출됩니다. 이 안에서 연결 성공 또는 실패에 따라 분기처리를 합니다.\nonBillingServiceDisconnected(): 앱과 Google Play의 연결이 끊어졌을 때 호출됩니다. 이 안에는 보통 연결을 재시도하는 로직이 포함됩니다.\n\nMainActivity에서 BillingManager클래스의 인스턴스를 생성합니다. 그리고 앱과 구글 플레이가 연결되면 구매 버튼을 활성화 합니다.\nMainActivity.ktkotlin123456789101112131415161718192021222324252627282930313233343536class MainActivity : AppCompatActivity() {    private val viewAdvertisement: ConstraintLayout by lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }    private val textViewVersion: TextView by lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }    private val buttonSubscribe: Button by lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }    private lateinit var billingManager: BillingManager    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupBilling()    }    private fun setupBilling() {        billingManager = BillingManager(this, object : BillingManager.Callback {            override fun onBillingManagerReady() {                // 구매 버튼 활성화                enableButtonSubscribe()            }            override fun onSuccess(purchase: Purchase) {                // ...            }            override fun onFailure(errorCode: Int) {                // ...            }        })    }    private fun enableButtonSubscribe() {        buttonSubscribe.isEnabled = true    }}\n\n구글 결제 API는 BillingResult 형식으로 오류를 반환합니다. BillingResult에는 BillingResponseCode가 포함되어 있어 앱에서 발생할 수 있는 결제 관련 오류를 구분할 수 있습니다. 또한 BillingResult에는 개발 중에 오류를 진단하는 데 유용한 디버그 메시지도 포함되어 있습니다.\nMainActivity.ktkotlin1234567891011121314151617181920212223242526class MainActivity : AppCompatActivity() {    // ...    private fun setupBilling() {        billingManager = BillingManager(this, object : BillingManager.Callback {            // ...            override fun onFailure(errorCode: Int) {                when (errorCode) {                    BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -&gt; {                        Toast.makeText(this@MainActivity, \"Cannot find item.\", Toast.LENGTH_LONG).show()                    }                    BillingClient.BillingResponseCode.USER_CANCELED -&gt; {                        Toast.makeText(this@MainActivity, \"Purchase cancelled.\", Toast.LENGTH_SHORT).show()                    }                    else -&gt; {                        Toast.makeText(applicationContext, \"Error: $errorCode\", Toast.LENGTH_SHORT).show()                    }                }            }        })    }}\n\n(13) 상품정보 불러오기이제 판매할 상품(구글 플레이에서 등록한 상품)의 정보를 불러와야합니다. BillingManager클래스에 상품 정보를 불러오는 querySkuDetails()을 정의합니다.\nBillingMananger.ktkotlin1234567891011121314class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun querySkuDetails(        type: String = BillingClient.SkuType.SUBS,        vararg skuIDs: String,        querySkuDetailsCallback: (List&lt;SkuDetails&gt;) -&gt; Unit    ) {        // ...    }}\n상품 정보를 불러올 때는 BillingClient클래스의 querySkuDetailsAsync()를 호출합니다. 이 메소드는 SkuDetailsParam클래스의 인스턴스를 인자로 전달받습니다.\nBillingMananger.ktkotlin12345678910111213141516171819202122232425class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun querySkuDetails(        type: String = BillingClient.SkuType.SUBS,        vararg skuIDs: String,        onResult: (List&lt;SkuDetails&gt;) -&gt; Unit    ) {        val params = SkuDetailsParams.newBuilder()            .setSkusList(skuIDs.toList())            .setType(type)            .build()        billingClient.querySkuDetailsAsync(params) { billingResult: BillingResult, skuDetailsList: List&lt;SkuDetails&gt;? -&gt;            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                onResult(skuDetailsList ?: emptyList())            } else {                callback.onFailure(billingResult.responseCode)            }        }    }}\nsetSkusList()의 인자로 조회할 제품들의 id를 리스트 형태로 전달합니다. 또한 setType()의 인자로 제품의 타입을 전달합니다. 제품의 타입은 다음과 같습니다.\n\nBillingClient.SkuType.INAPP: 일회성 제품(소모품, 비소모품)\nBillingClient.SkuType.SUBB: 정기 결제(구독)\n\nMainActivity에서 앱과 구글 플레이가 연결되었을 때 상품 목록을 조회하도록 구현합시다.\nBillingMananger.ktkotlin12345678910111213141516171819202122232425262728293031323334353637383940414243class MainActivity : AppCompatActivity() {    // ...    private var skuId = \"subscription_id\"    private lateinit var billingManager: BillingManager    private var mSkuDetailsList = listOf&lt;SkuDetails&gt;()    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupBilling()    }    private fun setupBilling() {        billingManager = BillingManager(this, object : BillingManager.Callback {            override fun onBillingManagerReady() {                // 구매 버튼 활성화                enableButtonSubscribe()                // 구매 가능한 제품 조회                billingManager.querySkuDetails(BillingClient.SkuType.SUBS, skuId) { skuDetailsList -&gt;                    runOnUiThread {                    // 조회한 제품 목록 저장                        mSkuDetailsList = skuDetailsList                    }                }            }            override fun onSuccess(purchase: Purchase) {                // ...            }            override fun onFailure(errorCode: Int) {                // ...            }        })    }}\nSkuDetails클래스에는 판매 가능한 제품의 세부정보가 포함되어있습니다. 자주 사용하는 메소드는 다음과 같습니다.\n\ngetTitle(): 상품 이름\ngetDescription(): 상품 상세 정보\ngetPrice(): 상품 가격\ngetType(): 상품 타입\n\n보통 SkuDetails를 사용하여 판매할 상품의 정보를 화면에 보여줍니다.\n(14) 상품 구매하기상품을 구매하고 결제하는 purchase()를 BillingManager클래스에 구현합니다. \nBillingMananger.ktkotlin1234567891011121314151617181920class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun purchase(skuDetails: SkuDetails) {        val flowParams = BillingFlowParams.newBuilder()            .setSkuDetails(skuDetails)            .build()        // 구매화면 표시        val responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode        if (responseCode != BillingClient.BillingResponseCode.OK) {            callback.onFailure(responseCode)        }        // Go to PurchasesUpdatedListener    }}\nBillingClient클래스의 launchBillingFlow()를 호출하면 다음과 같이 결제 화면이 표시되며 결제 프로세스를 시작합니다.이 메서드는 BillingClient.BillingResponseCode에 나열된 몇 가지 응답 코드 중 하나를 반환합니다. 이 값을 체크하여 결제 프로세스가 성공적으로 시작되었는지 확인할 수 있습니다. 결제 프로세스가 성공적으로 시작되면 BillingClient.BillingResponseCode.OK를 반환합니다.\nBillingMananger.ktkotlin123456789101112131415161718192021class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun purchase(skuDetails: SkuDetails) {        val flowParams = BillingFlowParams.newBuilder()            .setSkuDetails(skuDetails)            .build()        // 구매화면 표시        val responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode        // Go to PurchasesUpdatedListener        if (responseCode != BillingClient.BillingResponseCode.OK) {            // 구매 화면을 여는데 실패하면 이 부분이 호출            callback.onFailure(responseCode)        }    }}\nlaunchBillingFlow()는 결제 프로세스가 끝나면 결제가 성공적으로 완료되든, 사용자가 결제를 취소하든, 결제 프로세스에서 에러가 발생하든 상관없이 BillingClient클래스의 인스턴스를 초기화할 때 지정한 리스너로 이동하게 됩니다. 이 리스너에서 결제 프로세스의 결과를 처리할 수 있습니다.\nBillingMananger.ktkotlin123456789101112131415161718192021class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    private val purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != null) {            // 구매 성공 시         } else {            // 구매 실패 시            callback.onFailure(billingResult.responseCode)        }    }    private val billingClient = BillingClient.newBuilder(activity)        .setListener(purchasesUpdatedListener)        .enablePendingPurchases()        .build()    // ...}\n\n\n\n버튼을 눌렀을 때 purchase()를 호출합니다.\nMainActivity.ktkotlin1234567891011121314151617181920212223242526272829303132333435363738394041class MainActivity : AppCompatActivity() {    private val viewAdvertisement: ConstraintLayout by lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }    private val textViewVersion: TextView by lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }    private val buttonSubscribe: Button by lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }    private lateinit var billingManager: BillingManager    private var skuId = \"subscription_id\"    private var mSkuDetailsList = listOf&lt;SkuDetails&gt;()    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupUI()        setupBilling()    }    // ...    private fun setupUI() {        buttonSubscribe.setOnClickListener { purchase() }    }    private fun handleWhenSubscribing() {        viewAdvertisement.visibility = View.GONE        textViewVersion.text = \"Premium\"        textViewVersion.setTextColor(Color.RED)        buttonSubscribe.isEnabled = false        buttonSubscribe.visibility = View.GONE    }    private fun handleWhenUnsubscribing() {        viewAdvertisement.visibility = View.VISIBLE        textViewVersion.text = \"Free\"        textViewVersion.setTextColor(Color.BLACK)        buttonSubscribe.isEnabled = true        buttonSubscribe.visibility = View.VISIBLE    }}\n\n\n(15) 구매 처리정기 결제(구독)은 정상적으로 구매완료 시 구매 인정(Acknowledge)를 해야합니다. \n3일 이내 구매 인정(Acknowledge)을 하지 않으면 자동으로 환불됩니다.\n\nBillingManager 클래스에 구매 완료 시 구매 인정(Acknowledge)하는 handlePurchase()를 구현합시다. 이 메소드 안에서 BillingClient클래스의 acknowledgePurchase()를 호출하면 비동기적으로 구매를 구매 인정(Acknowledge)합니다. \nBillingMananger.ktkotlin12345678910111213141516171819202122232425class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    private fun handlePurchase(purchase: Purchase) {        if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {            if (!purchase.isAcknowledged) {                val acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()                    .setPurchaseToken(purchase.purchaseToken)                    .build()                billingClient.acknowledgePurchase(acknowledgePurchaseParams) { billingResult -&gt;                    if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                        callback.onSuccess(purchase)                    } else {                        callback.onFailure(billingResult.responseCode)                    }                }            }         }    }}\n\n구매가 성공했을 때 handlePurchase()를 호출해서 정기 결제(구독)을 구매 인정(Acknowledge)합니다.\nBillingMananger.ktkotlin123456789101112131415161718192021222324252627282930class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    private val purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != null) {            // 구매 성공            for (purchase in purchases) {                // 정기 결제(구독)은 구매 완료 시 인정(Acknowledge) 해야합니다.                // 3일 이내 인정(Acknowledge)를 하지 않으면 자동으로 환불됩니다.                handlePurchase(purchase)            }        } else {            // 구매 실패            callback.onFailure(billingResult.responseCode)        }    }    private val billingClient = BillingClient.newBuilder(activity)        .setListener(purchasesUpdatedListener)        .enablePendingPurchases()        .build()    private fun handlePurchase() {        // ...    }}\n\n(16) 구매 가져오기구매를 했으나 네트워크 문제 같은 외부적인 이유로 구매 인정(Acknowledge)가 되지 않을 수도 있습니다. 따라서 구매는 되었으나 구매 인정(Acknowledge)되지 않은 구매를 구매 인정(Acknowledge)하는 코드를 추가합시다.\nBillingMananger.ktkotlin12345678910111213141516171819202122232425class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun checkIfPurchasedButNotAcknowledged(type: String = BillingClient.SkuType.INAPP) {        if (billingClient.isReady) {            // 모든 구매 조회하기            billingClient.queryPurchasesAsync(type) { _: BillingResult, purchases: List&lt;Purchase&gt; -&gt;                if (purchases.isNotEmpty()) {                    for (purchase in purchases) {                        // 구매되었다면                        if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {                            // 구매되었으나 인정되지 않았다면                            if (!purchase.isAcknowledged) {                                handlePurchase(purchase)                            }                        }                    }                }             }        }     }}\nBillingClient객체의 queryPurchaseAsync()를 호출하면 모든 구매를 조회할 수 있습니다. 또한 조회한 Purchase객체의 isAcknowledged속성을 확인하면 구매했으나 인정(Acknowledge)하지 않은 구매를 확인할 수 있습니다.\nMainActivity의 onResume()에서 위 함수를 호출합니다.\nMainActivity.ktkotlin123456789class MainActivity : AppCompatActivity() {    // ...    override fun onResume() {        super.onResume()        billingManager.checkIfPurchasedButNotAcknowledged()    }}\n\n(17) 자원 해제BillingClient객체를 다 사용하면 연결을 끊어 자원을 해제해줍니다. BillingClient클래스의 endConnection()를 호출하면 구글 콘솔 플레이와의 연결이 해제됩니다.\nBillingMananger.ktkotlin12345678910class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun endConnection() {        billingClient.endConnection()    }}\nMainActivity의 onDestroy()에서 이 함수를 호출합니다.\nMainActivity.ktkotlin123456789class MainActivity : AppCompatActivity() {    // ...    override fun onDestroy() {        super.onDestroy()        billingManager.endConnection()    }}\n\n(18) 이미 구독 중인지 확인하기이 앱에는 문제가 있습니다. 앱을 재시작하면 구독 중임에도 여전히 광고가 보입니다. 또한 앱을 삭제 후 재설치해도 광고가 계속 보이게됩니다. 따라서 앱을 시작할 때 이미 구독 중인지 확인해야합니다.\nBillingManager클래스에 checkIfAlreadySubscribing()함수를 추가합시다.\nBillingManager.ktkotlin1234567891011121314151617181920212223242526272829303132class BillingManager(    private val activity: Activity,    private val callback: Callback) {    // ...    fun checkIfAlreadySubscribing(        sku: String,        type: String = BillingClient.SkuType.SUBS,        onResult: (isSubscribing: Boolean) -&gt; Unit    ) {        // queryPurchaseAsync()는 이전에 샀던 구매를 반환        // 구매하지 않았거나 환불된 제품은 queryPurchasesAsync()에서 조회되지 않습니다.        billingClient.queryPurchasesAsync(type) { billingResult, purchasesList: List&lt;Purchase&gt; -&gt;            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                if (purchasesList.isNotEmpty()) {                    // 이전에 구매한 구매(Purchase)들이 있으면                    for (purchase in purchasesList) {                        // 하나의 구매 안에는 여러 제품(sku)가 있다.                        purchase.skus.forEach {                            if (it == sku) {                                // id가 \"subscription_id\"인 제품을 이전에 구매한 적이 있다.                                return@forEach onResult(true)                            }                            return@forEach onResult(false)                        }                    }                }            }        }    }}\nMainActivity에서 이 함수를 호출합니다.\nMainActivity.ktkotlin12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455class MainActivity : AppCompatActivity() {    // ...    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupUI()        setupBilling()    }    private fun setupBilling() {        billingManager = BillingManager(this, object: BillingManager.Callback {            override fun onBillingManagerReady() {                enableButtonSubscribe()               // 이미 구독 중인지 확인                billingManager.checkIfAlreadySubscribing(skuId) { isSubscribing -&gt;                    if (isSubscribing) {                        // 구독 중이라면                        handleWhenSubscribing()                    } else {                        // 구독 중이 아니라면                        handleWhenUnsubscribing()                    }                }            }            // ...        })    }    private fun handleWhenSubscribing() {        viewAdvertisement.visibility = View.GONE        textViewVersion.text = \"Premium\"        textViewVersion.setTextColor(Color.RED)        buttonSubscribe.isEnabled = false        buttonSubscribe.visibility = View.GONE    }    private fun handleWhenUnsubscribing() {        viewAdvertisement.visibility = View.VISIBLE        textViewVersion.text = \"Free\"        textViewVersion.setTextColor(Color.BLACK)        buttonSubscribe.isEnabled = true        buttonSubscribe.visibility = View.VISIBLE    }    override fun onDestroy() {        super.onDestroy()        billingManager.endConnection()    }}\n\n(19) 비동기 처리와 UI 업데이트BillingClient클래스의 startConnection(), querySkuDetailsAsync(), launchBillingFlow(), consumeAsync()는 비동기적으로 작업을 수행합니다. 따라서 작업 종료 후 UI를 변경한다면, 이를 메인 스레드에서 수행해야합니다. UI를 변경하는 코드를 runOnUiThread()에서 수행하도록 코드를 수정하겠습니다.\nMainActivity의 전체 코드는 다음과 같습니다.\nMainActivity.ktkotlin123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122class MainActivity : AppCompatActivity() {    private val viewAdvertisement: ConstraintLayout by lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }    private val textViewVersion: TextView by lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }    private val buttonSubscribe: Button by lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }    private lateinit var billingManager: BillingManager    private var skuId = \"subscription_id\"    private var mSkuDetailsList = listOf&lt;SkuDetails&gt;()    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        setContentView(R.layout.activity_main)        setupUI()        setupBilling()    }    override fun onResume() {        super.onResume()        billingManager.checkIfPurchasedButNotAcknowledged()    }    private fun setupUI() {        buttonSubscribe.setOnClickListener { purchase() }    }    private fun setupBilling() {        billingManager = BillingManager(this, object: BillingManager.Callback {            override fun onBillingManagerReady() {                runOnUiThread {                    enableButtonSubscribe()                }                // 구매 가능한 제품 조회                billingManager.querySkuDetails(BillingClient.SkuType.SUBS, skuId) { skuDetailsList -&gt;                    runOnUiThread {                        mSkuDetailsList = skuDetailsList                    }                }               // 이미 구매했는지 확인                billingManager.checkIfAlreadySubscribing(skuId) { isSubscribing -&gt;                    if (isSubscribing) {                        runOnUiThread {                            handleWhenSubscribing()                        }                    } else {                        runOnUiThread {                            handleWhenUnsubscribing()                        }                    }                }            }            override fun onSuccess(purchase: Purchase) {                runOnUiThread {                    Toast.makeText(this@MainActivity, \"Successfully purchased.\", Toast.LENGTH_SHORT).show()                    handleWhenSubscribing()                }            }            override fun onFailure(errorCode: Int) {                when (errorCode) {                    BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -&gt; {                        runOnUiThread {                            Toast.makeText(this@MainActivity, \"Already purchased.\", Toast.LENGTH_SHORT).show()                        }                    }                    BillingClient.BillingResponseCode.USER_CANCELED -&gt; {                        runOnUiThread {                            Toast.makeText(this@MainActivity, \"Purchase cancelled.\", Toast.LENGTH_SHORT).show()                        }                    }                    else -&gt; {                        runOnUiThread {                            Toast.makeText(this@MainActivity, \"Error: $errorCode\", Toast.LENGTH_SHORT).show()                        }                    }                }            }        })    }    private fun purchase() {        for (skuDetail in mSkuDetailsList) {            if (skuDetail.sku == skuId) {                billingManager.purchase(skuDetail)            } else {                Toast.makeText(this@MainActivity, \"Cannot find item.\", Toast.LENGTH_LONG).show()            }        }    }    private fun enableButtonSubscribe() {        buttonSubscribe.isEnabled = true    }    private fun handleWhenSubscribing() {        viewAdvertisement.visibility = View.GONE        textViewVersion.text = \"Premium\"        textViewVersion.setTextColor(Color.RED)        buttonSubscribe.isEnabled = false        buttonSubscribe.visibility = View.GONE    }    private fun handleWhenUnsubscribing() {        viewAdvertisement.visibility = View.VISIBLE        textViewVersion.text = \"Free\"        textViewVersion.setTextColor(Color.BLACK)        buttonSubscribe.isEnabled = true        buttonSubscribe.visibility = View.VISIBLE    }    override fun onDestroy() {        super.onDestroy()        billingManager.endConnection()    }}\nBillingMananger의 전체 코드는 다음과 같습니다.\nBillingMananger.ktkotlin123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157class BillingManager(    private val activity: Activity,    private val callback: Callback) {    interface Callback {        fun onBillingManagerReady()        fun onSuccess(purchase: Purchase)        fun onFailure(errorCode: Int)    }    private val purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != null) {            // 구매 성공            for (purchase in purchases) {                // 정기 결제(구독)은 구매 완료 시 인정(Acknowledge) 해야합니다.                // 3일 이내 인정(Acknowledge)를 하지 않으면 자동으로 환불됩니다.                handlePurchase(purchase)            }        } else {            // 구매 실패            callback.onFailure(billingResult.responseCode)        }    }    private val billingClient = BillingClient.newBuilder(activity)        .setListener(purchasesUpdatedListener)        .enablePendingPurchases()        .build()    init {        billingClient.startConnection(object : BillingClientStateListener {            override fun onBillingSetupFinished(billingResult: BillingResult) {                when (billingResult.responseCode) {                    BillingClient.BillingResponseCode.OK -&gt; {                        callback.onBillingManagerReady()                    }                    else -&gt; {                        callback.onFailure(billingResult.responseCode)                    }                }            }            override fun onBillingServiceDisconnected() {            }        })    }    fun querySkuDetails(        type: String = BillingClient.SkuType.SUBS,        vararg skuIDs: String,        onResult: (List&lt;SkuDetails&gt;) -&gt; Unit    ) {        val params = SkuDetailsParams.newBuilder()            .setSkusList(skuIDs.toList())            .setType(type)            .build()        billingClient.querySkuDetailsAsync(params) { billingResult: BillingResult, skuDetailsList: List&lt;SkuDetails&gt;? -&gt;            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                onResult(skuDetailsList ?: emptyList())            } else {                callback.onFailure(billingResult.responseCode)            }        }    }    fun purchase(skuDetails: SkuDetails) {        val flowParams = BillingFlowParams.newBuilder()            .setSkuDetails(skuDetails)            .build()        // 구매화면 표시        val responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode        // Go to PurchasesUpdatedListener        if (responseCode != BillingClient.BillingResponseCode.OK) {            // 구매 화면을 여는데 실패하면 이 부분이 호출            callback.onFailure(responseCode)        }    }    private fun handlePurchase(purchase: Purchase) {        if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {            if (!purchase.isAcknowledged) {                val acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()                    .setPurchaseToken(purchase.purchaseToken)                    .build()                billingClient.acknowledgePurchase(acknowledgePurchaseParams) { billingResult -&gt;                    if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                        callback.onSuccess(purchase)                    } else {                        callback.onFailure(billingResult.responseCode)                    }                }            }         }     }    fun checkIfPurchasedButNotAcknowledged(type: String = BillingClient.SkuType.SUBS) {        if (billingClient.isReady) {            billingClient.queryPurchasesAsync(type) { _: BillingResult, purchases: List&lt;Purchase&gt; -&gt;                if (purchases.isNotEmpty()) {                    for (purchase in purchases) {                        if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {                            if (!purchase.isAcknowledged) {                                handlePurchase(purchase)                            }                         }                     }                }             }        }     }    fun checkIfAlreadySubscribing(        sku: String,        type: String = BillingClient.SkuType.SUBS,        onResult: (isSubscribing: Boolean) -&gt; Unit    ) {        // queryPurchaseAsync()는 이전에 샀던 구매를 반환        // 구매하지 않았거나 환불된 제품은 queryPurchasesAsync()에서 조회되지 않습니다.        billingClient.queryPurchasesAsync(type) { billingResult, purchasesList: List&lt;Purchase&gt; -&gt;            if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {                if (purchasesList.isNotEmpty()) {                    // 이전에 구매한 구매(Purchase)들이 있으면                    for (purchase in purchasesList) {                        // 하나의 구매 안에는 여러 제품(sku)가 있다.                        purchase.skus.forEach {                            if (it == sku) {                                // id가 \"subscription_id\"인 제품을 이전에 구매한 적이 있다.                                return@forEach onResult(true)                            }                            return@forEach onResult(false)                        }                    }                } else {                    // 이전에 구매한 구매(Purchase)들이 없으면                    return@queryPurchasesAsync onResult(false)                }            } else {                // queryPurchaseAsync() 호출에 실패                onResult(false)            }        }    }    fun endConnection() {        billingClient.endConnection()    }}\n\n(20) 구독 취소구매자는 정기 결제(구독) 내역을 확인할 수 있습니다. 구글 플레이스토어 앱에서 아바타 이미지를 클릭합니다.Payment &amp; Subscriptions을 선택합니다.Subscriptions을 선택합니다.구독 중인 정기결제를 확인할 수 있습니다. 현재 활성화된 구독의 상태는 Active로 표시되며, Next payment에서 다음 결제일과 결제 금액을 확인할 수 있습니다.해당 항목을 클릭하면 상세 내용을 확인할 수 있습니다. 또한 구독 중지와 구독 취소도 가능합니다.정기 결제를 취소하면 구독이 취소되는 날짜를 확인할 수 있습니다. 이 날짜까지는 구독권을 이용할 수 있습니다.구독권이 종료되면 구독의 상태가 Expired로 변경됩니다.구독을 취소해도 이미 요금을 지불한 기간 동안은 구독을 계속 사용할 수 있습니다. 예를 들어 7월 1일에 1,000원을 지불하여 1달 구독권을 구매한 후 7월 15일에 구독을 취소하면 다음과 같이 처리됩니다.\n\n7월 31일까지 구독권을 계속 이용할 수 있습니다.\n8월 1일에 구독료가 청구되지 않으며, 이때부터는 구독권을 이용할 수 없습니다.\n\n(21) 환불회사의 환불 정책에 따라 앱의 환불 방식이 달라질 수 있습니다. 보통 디지털 상품은 앱 내부에 환불을 구현하기보단 고객이 회사 고객센터에 직접 환불을 요청하는 식으로 구현합니다. 판매자는 구글 플레이 콘솔에서 환불을 처리할 수 있습니다. 이때는 구매자의 주문 ID(Order Id)가 필요합니다.\n판매자는 구글 플레이 콘솔 &gt; Order Management에서 환불을 진행할 수 있습니다.\n판매자는 구매자가 구독 취소를 했는지부터 확인합니다. 판매자는 구매자가 구독 취소를 하지 않았다면 Cancel Subscription버튼을 눌러 직접 구독 취소를 시킬 수 있습니다. 이 버튼을 누르면 구매자의 구독은 갱신되지 않으며, 구매자는 남은 구독 기간 동안만 구독권을 사용할 수 있습니다.\n구매자의 구독이 취소되었다면 Cancel Subscription버튼이 비활성화됩니다. 이제 판매자는 Refund 버튼을 눌러 환불을 진행합니다.\n구매자가 구독 취소를 이미 했다면 Cancel Subscription 버튼이 이미 비활성화 되어있습니다. 이 경우 판매자는 직접 구독 취소를 할 필요가 없이 Refund 버튼을 눌러 환불을 진행하면 됩니다.\n판매자는 갱신된 결제 건 별로 환불을 진행해야합니다.\n환불을 진행할 때 Remove entitlement에 반드시 체크합니다. 그렇지 않으면 환불은 되지만 구매자가 만료 기간까지 구독권을 사용할 수 있게 됩니다.\n","dateCreated":"2020-04-04T00:00:00+09:00","dateModified":"2021-12-16T17:08:02+09:00","datePublished":"2020-04-04T00:00:00+09:00","description":"","headline":"[결제(Payment)] (4) 인앱 결제(Google Play Billing API) - 정기 결제(구독)","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"},"publisher":{"@type":"Organization","name":"yologger","sameAs":[]},"url":"https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/","keywords":"Android, Payment"}</script>
    <meta name="description" content="들어가며여섯 개의 포스트에 걸쳐서 안드로이드 앱의 결제 방식에 대해 알아보고있습니다.  개요 인앱 결제(Google Play Billing API) - 소모품 인앱 결제(Google Play Billing API) - 비소모품 인앱 결제(Google Play Billing API) - 정기 결제(구독) VAN, PG, 간편 결제의 차이점 PG 결제 구현하">
<meta property="og:type" content="blog">
<meta property="og:title" content="[결제(Payment)] (4) 인앱 결제(Google Play Billing API) - 정기 결제(구독)">
<meta property="og:url" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/index.html">
<meta property="og:site_name" content="Yologger&#39;s Blog">
<meta property="og:description" content="들어가며여섯 개의 포스트에 걸쳐서 안드로이드 앱의 결제 방식에 대해 알아보고있습니다.  개요 인앱 결제(Google Play Billing API) - 소모품 인앱 결제(Google Play Billing API) - 비소모품 인앱 결제(Google Play Billing API) - 정기 결제(구독) VAN, PG, 간편 결제의 차이점 PG 결제 구현하">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/1.gif">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/2.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/3.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/4.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/5.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/6.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/7.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/8.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/9.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/10.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/11.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/12.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/13.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/14.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/15.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/16.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/17.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/18.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/19.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/20.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/21.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/22.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/23.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/24.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/24-1.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/25.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/26.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/21.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/30.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/31.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/32.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/33.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/34.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/35.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/36.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/37.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/38.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/38-1.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/39.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/40.png">
<meta property="og:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/42.png">
<meta property="article:published_time" content="2020-04-03T15:00:00.000Z">
<meta property="article:modified_time" content="2021-12-16T08:08:02.088Z">
<meta property="article:author" content="yologger">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Payment">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/1.gif">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/ko/assets/css/style-mg0ufdhe3lf13uaqzh5sfd3dtbhx3iokplil152c5hqau8lqr315qgpxsjvw.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QYKNWR810R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-QYKNWR810R');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ko/"
            aria-label=""
        >
            Yologger&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /ko/#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://yologger.github.io"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="English"
                        >
                        <i class="sidebar-button-icon fa fa-globe" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">English</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/yologger"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/mailto"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/java"
                            
                            rel="noopener"
                            title="Java"
                        >
                        <i class="sidebar-button-icon fab fa-java" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Java</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/kotlin"
                            
                            rel="noopener"
                            title="Kotlin"
                        >
                        <i class="sidebar-button-icon fab fa-korvue" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Kotlin</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/spring"
                            
                            rel="noopener"
                            title="Spring"
                        >
                        <i class="sidebar-button-icon fas fa-leaf" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Spring</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/android"
                            
                            rel="noopener"
                            title="Android"
                        >
                        <i class="sidebar-button-icon fab fa-android" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Android</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/infra_devops"
                            
                            rel="noopener"
                            title="Infra, DevOps"
                        >
                        <i class="sidebar-button-icon fa fa-server" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Infra, DevOps</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/tools"
                            
                            rel="noopener"
                            title="Tool"
                        >
                        <i class="sidebar-button-icon fa fa-wrench" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tool</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/ko/algorithm"
                            
                            rel="noopener"
                            title="Algorithm"
                        >
                        <i class="sidebar-button-icon fas fa-project-diagram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Algorithm</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            [결제(Payment)] (4) 인앱 결제(Google Play Billing API) - 정기 결제(구독)
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-04-04T00:00:00+09:00">
	
		    2020/04/04
    	
    </time>
    
        <span>카테고리 </span>
        
    <a class="category-link" href="/ko/categories/Android/">Android</a>, <a class="category-link" href="/ko/categories/Android/Payment/">Payment</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <hr>
<h1 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h1><p>여섯 개의 포스트에 걸쳐서 안드로이드 앱의 결제 방식에 대해 알아보고있습니다.</p>
<ol>
<li><a href="/ko/2020/04/01/08_android/07_payment/20200401_payment_intro/">개요</a></li>
<li><a href="/ko/2020/04/02/08_android/07_payment/20200402_GooglePlayBilling_ConsumableProduct/">인앱 결제(Google Play Billing API) - 소모품</a></li>
<li><a href="/ko/2020/04/03/08_android/07_payment/20200403_GooglePlayBilling_NonConsumableProduct/">인앱 결제(Google Play Billing API) - 비소모품</a></li>
<li><a href="/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/">인앱 결제(Google Play Billing API) - 정기 결제(구독)</a></li>
<li><a href="/ko/2020/04/05/08_android/07_payment/20200405_pg/">VAN, PG, 간편 결제의 차이점</a></li>
<li><a href="/ko/2020/04/06/08_android/07_payment/20200406_iamport/">PG 결제 구현하기(아임포트)</a></li>
</ol>
<hr>
<h1 id="디지털-제품"><a href="#디지털-제품" class="headerlink" title="디지털 제품"></a>디지털 제품</h1><p><code>구글 결제 API(Google Play Billing API)</code>를 사용하면 <code>디지털 제품</code>을 판매할 수 있습니다. 디지털 제품에는 두 종류가 있습니다.</p>
<h3 id="1-일회성-제품"><a href="#1-일회성-제품" class="headerlink" title="(1) 일회성 제품"></a>(1) 일회성 제품</h3><p><code>일회성 제품(One-time product)</code>은 사용자가 한번만 결제하여 구매할 수 있는 제품입니다. 일회성 제품에는 두 종류가 있습니다.</p>
<ul>
<li><code>소모품</code>: 게임 머니, 게임 화폐 같이 소비할 수 있는 제품입니다. 제품은 소비하면 다시 구매할 수 있습니다.</li>
<li><code>비소모품</code>: 한 번 구매하면 영구적으로 사용할 수 있는 제품입니다. 예를 들어 광고 제거, 프리미엄 버전 업그레이드가 있습니다.</li>
</ul>
<h3 id="2-정기-결제-구독"><a href="#2-정기-결제-구독" class="headerlink" title="(2) 정기 결제(구독)"></a>(2) 정기 결제(구독)</h3><p><code>정기 결제(구독)</code>는 반복적으로 청구되는 제품입니다. 유튜브 프리미엄, 음악 스트리밍 서비스, 뉴스 구독이 대표적인 정기 결제입니다. 정기 결제는 사용자가 직접 취소할 때까지 자동으로 갱신 및 결제됩니다.</p>
<hr>
<h1 id="정기-결제-구독-구현하기"><a href="#정기-결제-구독-구현하기" class="headerlink" title="정기 결제(구독) 구현하기"></a>정기 결제(구독) 구현하기</h1><p>다음과 같은 앱을 만들면서 정기 결제(구독)를 구현해보겠습니다.<br><img src="1.gif"></p>
<h3 id="1-개발자-계정-생성"><a href="#1-개발자-계정-생성" class="headerlink" title="(1) 개발자 계정 생성"></a>(1) 개발자 계정 생성</h3><p>앱을 테스트하거나 구글 플레이스토어에 출시하려면 <code>구글 개발자 계정</code>을 만들어야 합니다. <a target="_blank" rel="noopener" href="http://play.google.com/apps/publish/signup">이 곳</a>에 방문하여 구글 개발자 계정을 생성합니다. (현재는 미화로 25달러를 결제해야하며, 한번 결제 시 평생 이용할 수 있습니다.)</p>
<h3 id="2-결제-프로필-작성"><a href="#2-결제-프로필-작성" class="headerlink" title="(2) 결제 프로필 작성"></a>(2) 결제 프로필 작성</h3><p>이전에 작성한 적이 없다면 <code>결제 프로필</code>을 새롭게 작성해야합니다. <code>왼쪽 사이드바 메뉴 &gt; Setup &gt; Payment profile</code>로 이동하여 <code>Create payments profile</code>을 클릭합니다.<br><img src="2.png"><br>다음 항목이 제대로 입력되어있는지 확인합니다.<br><img src="3.png"></p>
<ul>
<li><code>Account type</code>: 계정 유형입니다. 개인과 기업으로 구분됩니다.</li>
<li><code>Tax information</code>: 세금 정보입니다. 개인 사업자와 법인 사업자로 구분됩니다.</li>
<li><code>Name and address</code>: 사업장 이름과 주소입니다.</li>
</ul>
<p><img src="4.png"></p>
<ul>
<li><code>Business name</code>: 사업장 이름 입니다.</li>
<li><code>Website</code>: 사업장 웹 사이트입니다.</li>
<li><code>What do you sell</code>: 판매할 상품입니다.</li>
<li><code>Customer support email</code>: 고객 지원 메일입니다.</li>
<li><code>Credit card statement name</code>: 신용카드 명세서 이름입니다.</li>
</ul>
<h3 id="3-구글-플레이-콘솔에-앱-생성하기"><a href="#3-구글-플레이-콘솔에-앱-생성하기" class="headerlink" title="(3) 구글 플레이 콘솔에 앱 생성하기"></a>(3) 구글 플레이 콘솔에 앱 생성하기</h3><p><code>구글 플레이 콘솔 &gt; All apps &gt; Create app</code>을 선택합니다.<br><img src="5.png"></p>
<p><code>App details</code>의 하위 항목을 입력합니다.<br><img src="6.png"></p>
<ul>
<li><code>App name</code>: 플레이 스토어에 출시되는 앱 이름</li>
<li><code>Default launguage</code>: 기본 언어</li>
<li><code>App or game</code>: 게임 앱인 경우 game, 그 외에는 App </li>
<li><code>Free or paid</code>: 무료 앱인 경우 free, 유료 앱인 경우 paid</li>
</ul>
<p><code>Declarations</code>의 하위 항목을 모두 체크합니다.<br><img src="7.png"></p>
<ul>
<li><code>Developer Program Policies</code>: 개발자 프로그램 정책에 동의</li>
<li><code>US export laws</code>: 미국 수출법규에 동의</li>
</ul>
<p><code>구글 플레이 콘솔 &gt; All apps</code>을 선택하면 생성한 앱을 확인할 수 있습니다.<br><img src="8.png"></p>
<h3 id="4-의존성-설정"><a href="#4-의존성-설정" class="headerlink" title="(4) 의존성 설정"></a>(4) 의존성 설정</h3><p>안드로이드 스튜디오에서 새로운 프로젝트를 생성하고 모듈 수준의 <code>build.gradle</code>에 의존성을 추가합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>모듈 수준의 build.gradle</span><ul class="tabs"><li class="tab active">groovy</li></ul></figcaption><div class="tabs-content"><figure class="highlight groovy" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Google Pay API</span></span><br><span class="line"><span class="keyword">def</span> billing_version = <span class="string">"4.0.0"</span></span><br><span class="line">implementation <span class="string">"com.android.billingclient:billing:$billing_version"</span></span><br></pre></td></tr></tbody></table></figure></div></figure>
<p>코틀린을 사용한다면 다음 의존성도 추가합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>모듈 수준의 build.gradle</span><ul class="tabs"><li class="tab active">groovy</li></ul></figcaption><div class="tabs-content"><figure class="highlight groovy" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">"com.android.billingclient:billing-ktx:$billing_version"</span></span><br></pre></td></tr></tbody></table></figure></div></figure>

<p>코루틴을 사용한다면 다음 의존성을 추가합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>모듈 수준의 build.gradle</span><ul class="tabs"><li class="tab active">groovy</li></ul></figcaption><div class="tabs-content"><figure class="highlight groovy" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> lifecycle_version = <span class="string">'2.2.0'</span> </span><br><span class="line">implementation <span class="string">"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version"</span></span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="5-권한-추가"><a href="#5-권한-추가" class="headerlink" title="(5) 권한 추가"></a>(5) 권한 추가</h3><p><code>AndroidManifest.xml</code>에 인터넷 권한과 결제 권한을 추가합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>AndroidManifest.xml</span><ul class="tabs"><li class="tab active">xml</li></ul></figcaption><div class="tabs-content"><figure class="highlight xml" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"com.yologger.inapp_payment_consumable_product"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.android.vending.BILLING"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="6-APK-파일-업로드"><a href="#6-APK-파일-업로드" class="headerlink" title="(6) APK 파일 업로드"></a>(6) APK 파일 업로드</h3><p>앱에서 판매할 상품은 구글 플레이 콘솔의 <code>Moentize &gt; Products &gt; Subscription</code>에서 추가합니다. 그러나 APK 파일을 업로드하지 않으면 이 페이지가 활성화되지 않습니다.<br><img src="9.png"></p>
<p>따라서 의존성과 권한만을 추가한 APK 파일을 업로드 하겠습니다. 실제 결제 로직은 다음 단계에서 구현합니다. </p>
<div class="alert warning icon"><p>구글 결제 API는 디버그 모드에서 테스트할 수 없습니다. 내부 테스트, 비공개 테스트, 공개 테스트, 정식 출시 중 어떤 형태로든 구글 플레이스토어에 출시가 되어야합니다. 이 포스트에서는 내부 테스트에 APK 파일을 업로드합니다.</p>
</div>

<div class="alert warning icon"><p>결제 테스트 시 구글 개발자 계정이 아닌 <u>다른 구글 계정</u>이 필요합니다. 구글 개발자 계정으로는 테스트할 수 없습니다.</p>
</div>

<p><code>Testing &gt; Internal Testing</code>으로 이동한 후 <code>Create new release</code>를 선택합니다.</p>
<p><img src="10.png"></p>
<p><code>Upload</code>를 클릭하고 APK 파일을 업로드합니다. 그리고 <code>Save</code>와 <code>Review release</code>를 순서대로 클릭합니다.<br><img src="11.png"></p>
<h3 id="7-판매할-상품-등록하기"><a href="#7-판매할-상품-등록하기" class="headerlink" title="(7) 판매할 상품 등록하기"></a>(7) 판매할 상품 등록하기</h3><p>다시 구글 플레이 콘솔의 <code>Moentize &gt; Products &gt; Subscriptions</code>로 이동합니다. 이제 아이템을 추가할 수 있게 되었습니다. <code>Create subscription</code> 버튼을 클릭합니다.<br><img src="12.png"></p>
<p>상품 정보를 입력합니다.<br><img src="13.png"></p>
<ul>
<li><code>Product ID</code>: 코드에서 판매 가능한 아이템을 조회할 때 사용하는 ID </li>
<li><code>Name</code>: 판매할 상품의 이름</li>
<li><code>Description</code>: 판매할 상품의 자세한 설명</li>
</ul>
<p>가격 정보를 입력합니다.<br><img src="14.png"></p>
<ul>
<li><code>Billing peroid</code>: 결제 주기를 선택합니다.</li>
<li><code>Default price</code>: 가격을 입력합니다.</li>
</ul>
<p>구독 옵션을 적절하게 선택합니다. 구독 옵션에서는 <code>무료 체험판</code>, <code>신규 할인 가격</code>, <code>유예 기간</code>, <code>재가입</code> 여부를 선택할 수 있습니다.<br><img src="15.png"></p>
<p><code>Save</code>버튼을 눌러 저장합니다.<br><img src="16.png"><br><code>Active</code>버튼을 눌러 상품을 활성화합니다.<br><img src="17.png"><br>상품이 정상적으로 추가되었습니다.<br><img src="18.png"></p>
<h3 id="8-라이선스-테스트에-계정-등록"><a href="#8-라이선스-테스트에-계정-등록" class="headerlink" title="(8) 라이선스 테스트에 계정 등록"></a>(8) 라이선스 테스트에 계정 등록</h3><p>라이선스 테스트에 등록한 계정은 결제를 해도 실제로 청구가 이루어지지 않습니다. 또한 정기 결제(구독)의 경우 원래 결제 주기(1주, 한달, 분기, 1년 등)가 아니라 <u>5분</u>에 한번씩 가상으로만 청구됩니다.<br><img src="19.png"></p>
<p><code>Setup &gt; License testing</code>으로 이동하여 이메일을 추가하면 됩니다.<br><img src="20.png"></p>
<p>라이선스 테스트에서 계정을 등록하지 않으면 구글 계정에 등록한 카드로 실제 결제됩니다.<br><img src="21.png"></p>
<p>실제로 결제되면 구매자 Gmail 계정으로 영수증이 전송됩니다.<br><img src="22.png"></p>
<p>만약 카드사에서 문자서비스를 신청했다면 결제 내역이 문자 메시지로 전송되기도 합니다.<br><img src="23.png"></p>
<p><code>Google Play Console &gt; Order managerment</code>에서 판매 내역을 확인할 수 있습니다.<br><img src="24.png"></p>
<p>구독 제품(정기 결제)는 설정한 주기에 따라 결제되며, <code>Order ID</code>에 <code>..0</code>, <code>..1</code>, <code>..2</code>처럼 숫자가 붙게됩니다.<br><img src="24-1.png"></p>
<p>오른쪽 화살표를 누르면 상세한 구매 내역도 확인할 수 있으며, 환불도 가능합니다.<br><img src="25.png"></p>
<h3 id="9-레이아웃-디자인하기"><a href="#9-레이아웃-디자인하기" class="headerlink" title="(9) 레이아웃 디자인하기"></a>(9) 레이아웃 디자인하기</h3><p>화면 레이아웃은 다음과 같습니다.<br><img src="26.png"></p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>activity_main.xml</span><ul class="tabs"><li class="tab active">xml</li></ul></figcaption><div class="tabs-content"><figure class="highlight xml" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_constraintLayout_ad"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"#009688"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"This is advertisement"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>\</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_linearlayout"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@+id/activity_main_button_subscribe"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_textView_title"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">"MeTube"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"30sp"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_margin</span>=<span class="string">"8dp"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_textView_version"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">"Free"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"15sp"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textStyle</span>=<span class="string">"bold"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/activity_main_button_subscribe"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"Subscribe"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@+id/activity_main_linearlayout"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></div></figure>


<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewAdvertisement: ConstraintLayout <span class="keyword">by</span> lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textViewVersion: TextView <span class="keyword">by</span> lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buttonSubscribe: Button <span class="keyword">by</span> lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="10-BillingManager-클래스-정의"><a href="#10-BillingManager-클래스-정의" class="headerlink" title="(10) BillingManager 클래스 정의"></a>(10) BillingManager 클래스 정의</h3><p>결제 관련 작업을 담당하는 <code>BillingManager</code>클래스를 정의하겠습니다. 또한 결제 관련 작업이 완료되었을 때 호출할 콜백을 인터페이스 형태로 정의합시다. <code>BillingManager</code>는 생성자의 인자로 액티비티와 콜백을 전달받습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>{</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<ul>
<li><code>onBillingManagerReady()</code>: 결제 준비가 완료되었을 때 호출되는 메소드</li>
<li><code>onSuccess(purchase: Purchase)</code>: 결제가 성공되었을 때 호출되는 메소드</li>
<li><code>onFailure(errorCode: Int)</code>: 결제가 실패했을 때 호출되는 메소드</li>
</ul>
<p><code>MainActivity</code>에서 <code>BillingManager</code>의 인스턴스를 생성합시다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewAdvertisement: ConstraintLayout <span class="keyword">by</span> lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textViewVersion: TextView <span class="keyword">by</span> lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buttonSubscribe: Button <span class="keyword">by</span> lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> billingManager: BillingManager</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span> : BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>


<h3 id="11-BillingClient-객체-초기화"><a href="#11-BillingClient-객체-초기화" class="headerlink" title="(11) BillingClient 객체 초기화"></a>(11) BillingClient 객체 초기화</h3><p>구글 결제 API는 결제 관련 작업을 위해 <code>BillingClient</code>클래스를 제공합니다. <code>BillingManager</code>에서 클래스의 인스턴스를 생성합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> billingClient = BillingClient.newBuilder(activity)</span><br><span class="line">        .setListener(purchasesUpdatedListener)</span><br><span class="line">        .enablePendingPurchases()</span><br><span class="line">        .build()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>BillingClient</code>객체를 생성할 때 <code>setListener()</code>함수에 <code>PurchasesUpdatedListener</code>의 구현체를 전달합니다. 이 구현체의 메소드는 결제를 요청한 후 호출됩니다. 이 메소드 안에서 결제 성공여부를 확인할 수 있습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;</span><br><span class="line">        <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 구매 성공 시</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 구매 실패 시</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> billingClient = BillingClient.newBuilder(activity)</span><br><span class="line">        .setListener(purchasesUpdatedListener)</span><br><span class="line">        .enablePendingPurchases()</span><br><span class="line">        .build()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>


<h3 id="12-앱과-Google-Play-연결하기"><a href="#12-앱과-Google-Play-연결하기" class="headerlink" title="(12) 앱과 Google Play 연결하기"></a>(12) 앱과 Google Play 연결하기</h3><p>이제 앱과 Google Play를 연결해야합니다. <code>BillingClient</code>클래스의 <code>startConnection()</code>을 호출하면 됩니다. <code>BillingMananger</code>클래스의 인스턴스를 생성할 때 가장 먼저 호출되는 <code>init</code>구문에서 이 메소드를 호출합시다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> {</span><br><span class="line">        billingClient.startConnection(<span class="keyword">object</span> : BillingClientStateListener {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingSetupFinished</span><span class="params">(billingResult: <span class="type">BillingResult</span>)</span></span> {</span><br><span class="line">                <span class="keyword">when</span> (billingResult.responseCode) {</span><br><span class="line">                    BillingClient.BillingResponseCode.OK -&gt; {</span><br><span class="line">                        <span class="comment">// Google Play와의 연결이 성공했을 때</span></span><br><span class="line">                        callback.onBillingManagerReady()</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> -&gt; {</span><br><span class="line">                        <span class="comment">// Google Play와의 연결이 실패했을 때</span></span><br><span class="line">                        callback.onFailure(billingResult.responseCode)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingServiceDisconnected</span><span class="params">()</span></span> {</span><br><span class="line">                <span class="comment">// Google Play와 연결이 끊어졌을 때 재시도하는 로직</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<ul>
<li><code>onBillingSetupFinished()</code>: 앱과 Google Play의 연결되었을 때 호출됩니다. 이 안에서 연결 성공 또는 실패에 따라 분기처리를 합니다.</li>
<li><code>onBillingServiceDisconnected()</code>: 앱과 Google Play의 연결이 끊어졌을 때 호출됩니다. 이 안에는 보통 연결을 재시도하는 로직이 포함됩니다.</li>
</ul>
<p><code>MainActivity</code>에서 <code>BillingManager</code>클래스의 인스턴스를 생성합니다. 그리고 앱과 구글 플레이가 연결되면 구매 버튼을 활성화 합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewAdvertisement: ConstraintLayout <span class="keyword">by</span> lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textViewVersion: TextView <span class="keyword">by</span> lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buttonSubscribe: Button <span class="keyword">by</span> lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> billingManager: BillingManager</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span> : BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span> {</span><br><span class="line">                <span class="comment">// 구매 버튼 활성화</span></span><br><span class="line">                enableButtonSubscribe()</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">enableButtonSubscribe</span><span class="params">()</span></span> {</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<p>구글 결제 API는 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/com/android/billingclient/api/BillingResult?hl=ko"><code>BillingResult</code></a> 형식으로 오류를 반환합니다. <code>BillingResult</code>에는 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponseCode?hl=ko"><code>BillingResponseCode</code></a>가 포함되어 있어 앱에서 발생할 수 있는 결제 관련 오류를 구분할 수 있습니다. 또한 <code>BillingResult</code>에는 개발 중에 오류를 진단하는 데 유용한 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/com/android/billingclient/api/BillingResult?hl=ko#getDebugMessage()">디버그 메시지</a>도 포함되어 있습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line"></span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span> : BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span> {</span><br><span class="line">                <span class="keyword">when</span> (errorCode) {</span><br><span class="line">                    BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -&gt; {</span><br><span class="line">                        Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Cannot find item."</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">                    }</span><br><span class="line">                    BillingClient.BillingResponseCode.USER_CANCELED -&gt; {</span><br><span class="line">                        Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Purchase cancelled."</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> -&gt; {</span><br><span class="line">                        Toast.makeText(applicationContext, <span class="string">"Error: <span class="variable">$errorCode</span>"</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="13-상품정보-불러오기"><a href="#13-상품정보-불러오기" class="headerlink" title="(13) 상품정보 불러오기"></a>(13) 상품정보 불러오기</h3><p>이제 판매할 상품(구글 플레이에서 등록한 상품)의 정보를 불러와야합니다. <code>BillingManager</code>클래스에 상품 정보를 불러오는 <code>querySkuDetails()</code>을 정의합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">querySkuDetails</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        type: <span class="type">String</span> = BillingClient.SkuType.SUBS,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">vararg</span> skuIDs: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        querySkuDetailsCallback: (<span class="type">List</span>&lt;<span class="type">SkuDetails</span>&gt;) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p>상품 정보를 불러올 때는 <code>BillingClient</code>클래스의 <code>querySkuDetailsAsync()</code>를 호출합니다. 이 메소드는 <code>SkuDetailsParam</code>클래스의 인스턴스를 인자로 전달받습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">querySkuDetails</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        type: <span class="type">String</span> = BillingClient.SkuType.SUBS,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">vararg</span> skuIDs: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        onResult: (<span class="type">List</span>&lt;<span class="type">SkuDetails</span>&gt;) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> {</span><br><span class="line">        <span class="keyword">val</span> params = SkuDetailsParams.newBuilder()</span><br><span class="line">            .setSkusList(skuIDs.toList())</span><br><span class="line">            .setType(type)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        billingClient.querySkuDetailsAsync(params) { billingResult: BillingResult, skuDetailsList: List&lt;SkuDetails&gt;? -&gt;</span><br><span class="line">            <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                onResult(skuDetailsList ?: emptyList())</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                callback.onFailure(billingResult.responseCode)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>setSkusList()</code>의 인자로 조회할 제품들의 id를 리스트 형태로 전달합니다. 또한 <code>setType()</code>의 인자로 제품의 타입을 전달합니다. 제품의 타입은 다음과 같습니다.</p>
<ul>
<li><code>BillingClient.SkuType.INAPP</code>: 일회성 제품(소모품, 비소모품)</li>
<li><code>BillingClient.SkuType.SUBB</code>: 정기 결제(구독)</li>
</ul>
<p><code>MainActivity</code>에서 앱과 구글 플레이가 연결되었을 때 상품 목록을 조회하도록 구현합시다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> skuId = <span class="string">"subscription_id"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> billingManager: BillingManager</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSkuDetailsList = listOf&lt;SkuDetails&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span> : BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span> {</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 구매 버튼 활성화</span></span><br><span class="line">                enableButtonSubscribe()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 구매 가능한 제품 조회</span></span><br><span class="line">                billingManager.querySkuDetails(BillingClient.SkuType.SUBS, skuId) { skuDetailsList -&gt;</span><br><span class="line">                    runOnUiThread {</span><br><span class="line">                    <span class="comment">// 조회한 제품 목록 저장</span></span><br><span class="line">                        mSkuDetailsList = skuDetailsList</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span> {</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/com/android/billingclient/api/SkuDetails?hl=ko"><code>SkuDetails</code></a>클래스에는 판매 가능한 제품의 세부정보가 포함되어있습니다. 자주 사용하는 메소드는 다음과 같습니다.</p>
<ul>
<li><code>getTitle()</code>: 상품 이름</li>
<li><code>getDescription()</code>: 상품 상세 정보</li>
<li><code>getPrice()</code>: 상품 가격</li>
<li><code>getType()</code>: 상품 타입</li>
</ul>
<p>보통 <code>SkuDetails</code>를 사용하여 판매할 상품의 정보를 화면에 보여줍니다.</p>
<h3 id="14-상품-구매하기"><a href="#14-상품-구매하기" class="headerlink" title="(14) 상품 구매하기"></a>(14) 상품 구매하기</h3><p>상품을 구매하고 결제하는 <code>purchase()</code>를 <code>BillingManager</code>클래스에 구현합니다. </p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">purchase</span><span class="params">(skuDetails: <span class="type">SkuDetails</span>)</span></span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> flowParams = BillingFlowParams.newBuilder()</span><br><span class="line">            .setSkuDetails(skuDetails)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 구매화면 표시</span></span><br><span class="line">        <span class="keyword">val</span> responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode</span><br><span class="line">        <span class="keyword">if</span> (responseCode != BillingClient.BillingResponseCode.OK) {</span><br><span class="line">            callback.onFailure(responseCode)</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Go to PurchasesUpdatedListener</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>BillingClient</code>클래스의 <code>launchBillingFlow()</code>를 호출하면 다음과 같이 결제 화면이 표시되며 결제 프로세스를 시작합니다.<br><img src="21.png"><br>이 메서드는 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponseCode?hl=ko"><code>BillingClient.BillingResponseCode</code></a>에 나열된 몇 가지 응답 코드 중 하나를 반환합니다. 이 값을 체크하여 결제 프로세스가 성공적으로 시작되었는지 확인할 수 있습니다. 결제 프로세스가 성공적으로 시작되면 <code>BillingClient.BillingResponseCode.OK</code>를 반환합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">purchase</span><span class="params">(skuDetails: <span class="type">SkuDetails</span>)</span></span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> flowParams = BillingFlowParams.newBuilder()</span><br><span class="line">            .setSkuDetails(skuDetails)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 구매화면 표시</span></span><br><span class="line">        <span class="keyword">val</span> responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode</span><br><span class="line">        <span class="comment">// Go to PurchasesUpdatedListener</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseCode != BillingClient.BillingResponseCode.OK) {</span><br><span class="line">            <span class="comment">// 구매 화면을 여는데 실패하면 이 부분이 호출</span></span><br><span class="line">            callback.onFailure(responseCode)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>launchBillingFlow()</code>는 결제 프로세스가 끝나면 결제가 성공적으로 완료되든, 사용자가 결제를 취소하든, 결제 프로세스에서 에러가 발생하든 상관없이 <code>BillingClient</code>클래스의 인스턴스를 초기화할 때 지정한 리스너로 이동하게 됩니다. 이 리스너에서 결제 프로세스의 결과를 처리할 수 있습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;</span><br><span class="line">        <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 구매 성공 시 </span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 구매 실패 시</span></span><br><span class="line">            callback.onFailure(billingResult.responseCode)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> billingClient = BillingClient.newBuilder(activity)</span><br><span class="line">        .setListener(purchasesUpdatedListener)</span><br><span class="line">        .enablePendingPurchases()</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>



<p>버튼을 눌렀을 때 <code>purchase()</code>를 호출합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewAdvertisement: ConstraintLayout <span class="keyword">by</span> lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textViewVersion: TextView <span class="keyword">by</span> lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buttonSubscribe: Button <span class="keyword">by</span> lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> billingManager: BillingManager</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> skuId = <span class="string">"subscription_id"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSkuDetailsList = listOf&lt;SkuDetails&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupUI()</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupUI</span><span class="params">()</span></span> {</span><br><span class="line">        buttonSubscribe.setOnClickListener { purchase() }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenSubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.GONE</span><br><span class="line">        textViewVersion.text = <span class="string">"Premium"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.RED)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">false</span></span><br><span class="line">        buttonSubscribe.visibility = View.GONE</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenUnsubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.VISIBLE</span><br><span class="line">        textViewVersion.text = <span class="string">"Free"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.BLACK)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">true</span></span><br><span class="line">        buttonSubscribe.visibility = View.VISIBLE</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>


<h3 id="15-구매-처리"><a href="#15-구매-처리" class="headerlink" title="(15) 구매 처리"></a>(15) 구매 처리</h3><p>정기 결제(구독)은 정상적으로 구매완료 시 <code>구매 인정(Acknowledge)</code>를 해야합니다. </p>
<div class="alert warning icon"><p>3일 이내 <u>구매 인정(Acknowledge)</u>을 하지 않으면 자동으로 환불됩니다.</p>
</div>
<p><code>BillingManager</code> 클래스에 구매 완료 시 <code>구매 인정(Acknowledge)</code>하는 <code>handlePurchase()</code>를 구현합시다. 이 메소드 안에서 <code>BillingClient</code>클래스의 <code>acknowledgePurchase()</code>를 호출하면 비동기적으로 구매를 <code>구매 인정(Acknowledge)</code>합니다. </p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handlePurchase</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {</span><br><span class="line">            <span class="keyword">if</span> (!purchase.isAcknowledged) {</span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()</span><br><span class="line">                    .setPurchaseToken(purchase.purchaseToken)</span><br><span class="line">                    .build()</span><br><span class="line"></span><br><span class="line">                billingClient.acknowledgePurchase(acknowledgePurchaseParams) { billingResult -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                        callback.onSuccess(purchase)</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        callback.onFailure(billingResult.responseCode)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<p>구매가 성공했을 때 <code>handlePurchase()</code>를 호출해서 정기 결제(구독)을 <code>구매 인정(Acknowledge)</code>합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 구매 성공</span></span><br><span class="line">            <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchases) {</span><br><span class="line">                <span class="comment">// 정기 결제(구독)은 구매 완료 시 인정(Acknowledge) 해야합니다.</span></span><br><span class="line">                <span class="comment">// 3일 이내 인정(Acknowledge)를 하지 않으면 자동으로 환불됩니다.</span></span><br><span class="line">                handlePurchase(purchase)</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 구매 실패</span></span><br><span class="line">            callback.onFailure(billingResult.responseCode)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> billingClient = BillingClient.newBuilder(activity)</span><br><span class="line">        .setListener(purchasesUpdatedListener)</span><br><span class="line">        .enablePendingPurchases()</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handlePurchase</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="16-구매-가져오기"><a href="#16-구매-가져오기" class="headerlink" title="(16) 구매 가져오기"></a>(16) 구매 가져오기</h3><p>구매를 했으나 네트워크 문제 같은 외부적인 이유로 <code>구매 인정(Acknowledge)</code>가 되지 않을 수도 있습니다. 따라서 구매는 되었으나 <code>구매 인정(Acknowledge)</code>되지 않은 구매를 <code>구매 인정(Acknowledge)</code>하는 코드를 추가합시다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkIfPurchasedButNotAcknowledged</span><span class="params">(type: <span class="type">String</span> = BillingClient.SkuType.INAPP)</span></span> {</span><br><span class="line">        <span class="keyword">if</span> (billingClient.isReady) {</span><br><span class="line">            <span class="comment">// 모든 구매 조회하기</span></span><br><span class="line">            billingClient.queryPurchasesAsync(type) { _: BillingResult, purchases: List&lt;Purchase&gt; -&gt;</span><br><span class="line">                <span class="keyword">if</span> (purchases.isNotEmpty()) {</span><br><span class="line">                    <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchases) {</span><br><span class="line">                        <span class="comment">// 구매되었다면</span></span><br><span class="line">                        <span class="keyword">if</span> (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {</span><br><span class="line">                            <span class="comment">// 구매되었으나 인정되지 않았다면</span></span><br><span class="line">                            <span class="keyword">if</span> (!purchase.isAcknowledged) {</span><br><span class="line">                                handlePurchase(purchase)</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                } </span><br><span class="line">            }</span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>BillingClient</code>객체의 <code>queryPurchaseAsync()</code>를 호출하면 모든 구매를 조회할 수 있습니다. 또한 조회한 <code>Purchase</code>객체의 <code>isAcknowledged</code>속성을 확인하면 구매했으나 <code>인정(Acknowledge)</code>하지 않은 구매를 확인할 수 있습니다.</p>
<p><code>MainActivity</code>의 <code>onResume()</code>에서 위 함수를 호출합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onResume()</span><br><span class="line">        billingManager.checkIfPurchasedButNotAcknowledged()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="17-자원-해제"><a href="#17-자원-해제" class="headerlink" title="(17) 자원 해제"></a>(17) 자원 해제</h3><p><code>BillingClient</code>객체를 다 사용하면 연결을 끊어 자원을 해제해줍니다. <code>BillingClient</code>클래스의 <code>endConnection()</code>를 호출하면 구글 콘솔 플레이와의 연결이 해제됩니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">endConnection</span><span class="params">()</span></span> {</span><br><span class="line">        billingClient.endConnection()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>MainActivity</code>의 <code>onDestroy()</code>에서 이 함수를 호출합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">        billingManager.endConnection()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="18-이미-구독-중인지-확인하기"><a href="#18-이미-구독-중인지-확인하기" class="headerlink" title="(18) 이미 구독 중인지 확인하기"></a>(18) 이미 구독 중인지 확인하기</h3><p>이 앱에는 문제가 있습니다. 앱을 재시작하면 구독 중임에도 여전히 광고가 보입니다. 또한 앱을 삭제 후 재설치해도 광고가 계속 보이게됩니다. 따라서 앱을 시작할 때 이미 구독 중인지 확인해야합니다.</p>
<p><code>BillingManager</code>클래스에 <code>checkIfAlreadySubscribing()</code>함수를 추가합시다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingManager.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkIfAlreadySubscribing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        sku: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        type: <span class="type">String</span> = BillingClient.SkuType.SUBS,</span></span></span><br><span class="line"><span class="params"><span class="function">        onResult: (<span class="type">isSubscribing</span>: <span class="type">Boolean</span>) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> {</span><br><span class="line">        <span class="comment">// queryPurchaseAsync()는 이전에 샀던 구매를 반환</span></span><br><span class="line">        <span class="comment">// 구매하지 않았거나 환불된 제품은 queryPurchasesAsync()에서 조회되지 않습니다.</span></span><br><span class="line">        billingClient.queryPurchasesAsync(type) { billingResult, purchasesList: List&lt;Purchase&gt; -&gt;</span><br><span class="line">            <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                <span class="keyword">if</span> (purchasesList.isNotEmpty()) {</span><br><span class="line">                    <span class="comment">// 이전에 구매한 구매(Purchase)들이 있으면</span></span><br><span class="line">                    <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchasesList) {</span><br><span class="line">                        <span class="comment">// 하나의 구매 안에는 여러 제품(sku)가 있다.</span></span><br><span class="line">                        purchase.skus.forEach {</span><br><span class="line">                            <span class="keyword">if</span> (it == sku) {</span><br><span class="line">                                <span class="comment">// id가 "subscription_id"인 제품을 이전에 구매한 적이 있다.</span></span><br><span class="line">                                <span class="keyword">return</span><span class="symbol">@forEach</span> onResult(<span class="literal">true</span>)</span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">return</span><span class="symbol">@forEach</span> onResult(<span class="literal">false</span>)</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>MainActivity</code>에서 이 함수를 호출합니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupUI()</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span>: BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span> {</span><br><span class="line"></span><br><span class="line">                enableButtonSubscribe()</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 이미 구독 중인지 확인</span></span><br><span class="line">                billingManager.checkIfAlreadySubscribing(skuId) { isSubscribing -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (isSubscribing) {</span><br><span class="line">                        <span class="comment">// 구독 중이라면</span></span><br><span class="line">                        handleWhenSubscribing()</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="comment">// 구독 중이 아니라면</span></span><br><span class="line">                        handleWhenUnsubscribing()</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenSubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.GONE</span><br><span class="line">        textViewVersion.text = <span class="string">"Premium"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.RED)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">false</span></span><br><span class="line">        buttonSubscribe.visibility = View.GONE</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenUnsubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.VISIBLE</span><br><span class="line">        textViewVersion.text = <span class="string">"Free"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.BLACK)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">true</span></span><br><span class="line">        buttonSubscribe.visibility = View.VISIBLE</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">        billingManager.endConnection()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="19-비동기-처리와-UI-업데이트"><a href="#19-비동기-처리와-UI-업데이트" class="headerlink" title="(19) 비동기 처리와 UI 업데이트"></a>(19) 비동기 처리와 UI 업데이트</h3><p><code>BillingClient</code>클래스의 <code>startConnection()</code>, <code>querySkuDetailsAsync()</code>, <code>launchBillingFlow()</code>, <code>consumeAsync()</code>는 비동기적으로 작업을 수행합니다. 따라서 작업 종료 후 UI를 변경한다면, 이를 메인 스레드에서 수행해야합니다. UI를 변경하는 코드를 <code>runOnUiThread()</code>에서 수행하도록 코드를 수정하겠습니다.</p>
<p><code>MainActivity</code>의 전체 코드는 다음과 같습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>MainActivity.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewAdvertisement: ConstraintLayout <span class="keyword">by</span> lazy { findViewById&lt;ConstraintLayout&gt;(R.id.activity_main_constraintLayout_ad) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textViewVersion: TextView <span class="keyword">by</span> lazy { findViewById&lt;TextView&gt;(R.id.activity_main_textView_version) }</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buttonSubscribe: Button <span class="keyword">by</span> lazy { findViewById&lt;Button&gt;(R.id.activity_main_button_subscribe) }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> billingManager: BillingManager</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> skuId = <span class="string">"subscription_id"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSkuDetailsList = listOf&lt;SkuDetails&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        setupUI()</span><br><span class="line">        setupBilling()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onResume()</span><br><span class="line">        billingManager.checkIfPurchasedButNotAcknowledged()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupUI</span><span class="params">()</span></span> {</span><br><span class="line">        buttonSubscribe.setOnClickListener { purchase() }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setupBilling</span><span class="params">()</span></span> {</span><br><span class="line">        billingManager = BillingManager(<span class="keyword">this</span>, <span class="keyword">object</span>: BillingManager.Callback {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span> {</span><br><span class="line">                runOnUiThread {</span><br><span class="line">                    enableButtonSubscribe()</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 구매 가능한 제품 조회</span></span><br><span class="line">                billingManager.querySkuDetails(BillingClient.SkuType.SUBS, skuId) { skuDetailsList -&gt;</span><br><span class="line">                    runOnUiThread {</span><br><span class="line">                        mSkuDetailsList = skuDetailsList</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 이미 구매했는지 확인</span></span><br><span class="line">                billingManager.checkIfAlreadySubscribing(skuId) { isSubscribing -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (isSubscribing) {</span><br><span class="line">                        runOnUiThread {</span><br><span class="line">                            handleWhenSubscribing()</span><br><span class="line">                        }</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        runOnUiThread {</span><br><span class="line">                            handleWhenUnsubscribing()</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line">                runOnUiThread {</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Successfully purchased."</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                    handleWhenSubscribing()</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span> {</span><br><span class="line">                <span class="keyword">when</span> (errorCode) {</span><br><span class="line">                    BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -&gt; {</span><br><span class="line">                        runOnUiThread {</span><br><span class="line">                            Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Already purchased."</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    BillingClient.BillingResponseCode.USER_CANCELED -&gt; {</span><br><span class="line">                        runOnUiThread {</span><br><span class="line">                            Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Purchase cancelled."</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> -&gt; {</span><br><span class="line">                        runOnUiThread {</span><br><span class="line">                            Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Error: <span class="variable">$errorCode</span>"</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">purchase</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">for</span> (skuDetail <span class="keyword">in</span> mSkuDetailsList) {</span><br><span class="line">            <span class="keyword">if</span> (skuDetail.sku == skuId) {</span><br><span class="line">                billingManager.purchase(skuDetail)</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">"Cannot find item."</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">enableButtonSubscribe</span><span class="params">()</span></span> {</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenSubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.GONE</span><br><span class="line">        textViewVersion.text = <span class="string">"Premium"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.RED)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">false</span></span><br><span class="line">        buttonSubscribe.visibility = View.GONE</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleWhenUnsubscribing</span><span class="params">()</span></span> {</span><br><span class="line">        viewAdvertisement.visibility = View.VISIBLE</span><br><span class="line">        textViewVersion.text = <span class="string">"Free"</span></span><br><span class="line">        textViewVersion.setTextColor(Color.BLACK)</span><br><span class="line">        buttonSubscribe.isEnabled = <span class="literal">true</span></span><br><span class="line">        buttonSubscribe.visibility = View.VISIBLE</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">        billingManager.endConnection()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>
<p><code>BillingMananger</code>의 전체 코드는 다음과 같습니다.</p>
<figure class="codeblock codeblock--tabbed"><figcaption><span>BillingMananger.kt</span><ul class="tabs"><li class="tab active">kotlin</li></ul></figcaption><div class="tabs-content"><figure class="highlight kotlin" style="display: block;"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingManager</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activity: Activity,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callback: Callback</span><br><span class="line">) {</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>{</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onBillingManagerReady</span><span class="params">()</span></span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(errorCode: <span class="type">Int</span>)</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> purchasesUpdatedListener = PurchasesUpdatedListener { billingResult, purchases -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; purchases != <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 구매 성공</span></span><br><span class="line">            <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchases) {</span><br><span class="line">                <span class="comment">// 정기 결제(구독)은 구매 완료 시 인정(Acknowledge) 해야합니다.</span></span><br><span class="line">                <span class="comment">// 3일 이내 인정(Acknowledge)를 하지 않으면 자동으로 환불됩니다.</span></span><br><span class="line">                handlePurchase(purchase)</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 구매 실패</span></span><br><span class="line">            callback.onFailure(billingResult.responseCode)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> billingClient = BillingClient.newBuilder(activity)</span><br><span class="line">        .setListener(purchasesUpdatedListener)</span><br><span class="line">        .enablePendingPurchases()</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> {</span><br><span class="line">        billingClient.startConnection(<span class="keyword">object</span> : BillingClientStateListener {</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingSetupFinished</span><span class="params">(billingResult: <span class="type">BillingResult</span>)</span></span> {</span><br><span class="line">                <span class="keyword">when</span> (billingResult.responseCode) {</span><br><span class="line">                    BillingClient.BillingResponseCode.OK -&gt; {</span><br><span class="line">                        callback.onBillingManagerReady()</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> -&gt; {</span><br><span class="line">                        callback.onFailure(billingResult.responseCode)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBillingServiceDisconnected</span><span class="params">()</span></span> {</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">querySkuDetails</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        type: <span class="type">String</span> = BillingClient.SkuType.SUBS,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">vararg</span> skuIDs: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        onResult: (<span class="type">List</span>&lt;<span class="type">SkuDetails</span>&gt;) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> {</span><br><span class="line">        <span class="keyword">val</span> params = SkuDetailsParams.newBuilder()</span><br><span class="line">            .setSkusList(skuIDs.toList())</span><br><span class="line">            .setType(type)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        billingClient.querySkuDetailsAsync(params) { billingResult: BillingResult, skuDetailsList: List&lt;SkuDetails&gt;? -&gt;</span><br><span class="line">            <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                onResult(skuDetailsList ?: emptyList())</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                callback.onFailure(billingResult.responseCode)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">purchase</span><span class="params">(skuDetails: <span class="type">SkuDetails</span>)</span></span> {</span><br><span class="line">        <span class="keyword">val</span> flowParams = BillingFlowParams.newBuilder()</span><br><span class="line">            .setSkuDetails(skuDetails)</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 구매화면 표시</span></span><br><span class="line">        <span class="keyword">val</span> responseCode = billingClient.launchBillingFlow(activity, flowParams).responseCode</span><br><span class="line">        <span class="comment">// Go to PurchasesUpdatedListener</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseCode != BillingClient.BillingResponseCode.OK) {</span><br><span class="line">            <span class="comment">// 구매 화면을 여는데 실패하면 이 부분이 호출</span></span><br><span class="line">            callback.onFailure(responseCode)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handlePurchase</span><span class="params">(purchase: <span class="type">Purchase</span>)</span></span> {</span><br><span class="line">        <span class="keyword">if</span> (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {</span><br><span class="line">            <span class="keyword">if</span> (!purchase.isAcknowledged) {</span><br><span class="line">                <span class="keyword">val</span> acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()</span><br><span class="line">                    .setPurchaseToken(purchase.purchaseToken)</span><br><span class="line">                    .build()</span><br><span class="line"></span><br><span class="line">                billingClient.acknowledgePurchase(acknowledgePurchaseParams) { billingResult -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                        callback.onSuccess(purchase)</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        callback.onFailure(billingResult.responseCode)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } </span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkIfPurchasedButNotAcknowledged</span><span class="params">(type: <span class="type">String</span> = BillingClient.SkuType.SUBS)</span></span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (billingClient.isReady) {</span><br><span class="line">            billingClient.queryPurchasesAsync(type) { _: BillingResult, purchases: List&lt;Purchase&gt; -&gt;</span><br><span class="line">                <span class="keyword">if</span> (purchases.isNotEmpty()) {</span><br><span class="line">                    <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchases) {</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {</span><br><span class="line">                            <span class="keyword">if</span> (!purchase.isAcknowledged) {</span><br><span class="line">                                handlePurchase(purchase)</span><br><span class="line">                            } </span><br><span class="line">                        } </span><br><span class="line">                    }</span><br><span class="line">                } </span><br><span class="line">            }</span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkIfAlreadySubscribing</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        sku: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        type: <span class="type">String</span> = BillingClient.SkuType.SUBS,</span></span></span><br><span class="line"><span class="params"><span class="function">        onResult: (<span class="type">isSubscribing</span>: <span class="type">Boolean</span>) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> {</span><br><span class="line">        <span class="comment">// queryPurchaseAsync()는 이전에 샀던 구매를 반환</span></span><br><span class="line">        <span class="comment">// 구매하지 않았거나 환불된 제품은 queryPurchasesAsync()에서 조회되지 않습니다.</span></span><br><span class="line">        billingClient.queryPurchasesAsync(type) { billingResult, purchasesList: List&lt;Purchase&gt; -&gt;</span><br><span class="line">            <span class="keyword">if</span> (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {</span><br><span class="line">                <span class="keyword">if</span> (purchasesList.isNotEmpty()) {</span><br><span class="line">                    <span class="comment">// 이전에 구매한 구매(Purchase)들이 있으면</span></span><br><span class="line">                    <span class="keyword">for</span> (purchase <span class="keyword">in</span> purchasesList) {</span><br><span class="line">                        <span class="comment">// 하나의 구매 안에는 여러 제품(sku)가 있다.</span></span><br><span class="line">                        purchase.skus.forEach {</span><br><span class="line">                            <span class="keyword">if</span> (it == sku) {</span><br><span class="line">                                <span class="comment">// id가 "subscription_id"인 제품을 이전에 구매한 적이 있다.</span></span><br><span class="line">                                <span class="keyword">return</span><span class="symbol">@forEach</span> onResult(<span class="literal">true</span>)</span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">return</span><span class="symbol">@forEach</span> onResult(<span class="literal">false</span>)</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 이전에 구매한 구매(Purchase)들이 없으면</span></span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@queryPurchasesAsync</span> onResult(<span class="literal">false</span>)</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// queryPurchaseAsync() 호출에 실패</span></span><br><span class="line">                onResult(<span class="literal">false</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">endConnection</span><span class="params">()</span></span> {</span><br><span class="line">        billingClient.endConnection()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure>

<h3 id="20-구독-취소"><a href="#20-구독-취소" class="headerlink" title="(20) 구독 취소"></a>(20) 구독 취소</h3><p>구매자는 정기 결제(구독) 내역을 확인할 수 있습니다. <code>구글 플레이스토어 앱</code>에서 <code>아바타 이미지</code>를 클릭합니다.<br><img src="30.png"><br><code>Payment &amp; Subscriptions</code>을 선택합니다.<br><img src="31.png"><br><code>Subscriptions</code>을 선택합니다.<br><img src="32.png"><br>구독 중인 정기결제를 확인할 수 있습니다. 현재 활성화된 구독의 상태는 <code>Active</code>로 표시되며, <code>Next payment</code>에서 다음 결제일과 결제 금액을 확인할 수 있습니다.<br><img src="33.png"><br>해당 항목을 클릭하면 상세 내용을 확인할 수 있습니다. 또한 <code>구독 중지</code>와 <code>구독 취소</code>도 가능합니다.<br><img src="34.png"><br>정기 결제를 취소하면 구독이 취소되는 날짜를 확인할 수 있습니다. 이 날짜까지는 구독권을 이용할 수 있습니다.<br><img src="35.png"><br>구독권이 종료되면 구독의 상태가 <code>Expired</code>로 변경됩니다.<br><img src="36.png"><br>구독을 취소해도 이미 요금을 지불한 기간 동안은 구독을 계속 사용할 수 있습니다. 예를 들어 7월 1일에 1,000원을 지불하여 1달 구독권을 구매한 후 7월 15일에 구독을 취소하면 다음과 같이 처리됩니다.</p>
<ul>
<li>7월 31일까지 구독권을 계속 이용할 수 있습니다.</li>
<li>8월 1일에 구독료가 청구되지 않으며, 이때부터는 구독권을 이용할 수 없습니다.</li>
</ul>
<h3 id="21-환불"><a href="#21-환불" class="headerlink" title="(21) 환불"></a>(21) 환불</h3><p>회사의 환불 정책에 따라 앱의 환불 방식이 달라질 수 있습니다. 보통 디지털 상품은 앱 내부에 환불을 구현하기보단 고객이 회사 고객센터에 직접 환불을 요청하는 식으로 구현합니다. 판매자는 구글 플레이 콘솔에서 환불을 처리할 수 있습니다. 이때는 구매자의 <code>주문 ID(Order Id)</code>가 필요합니다.</p>
<p>판매자는 <code>구글 플레이 콘솔 &gt; Order Management</code>에서 환불을 진행할 수 있습니다.<br><img src="37.png"></p>
<p>판매자는 구매자가 구독 취소를 했는지부터 확인합니다. 판매자는 구매자가 구독 취소를 하지 않았다면 <code>Cancel Subscription</code>버튼을 눌러 직접 구독 취소를 시킬 수 있습니다. 이 버튼을 누르면 구매자의 구독은 갱신되지 않으며, 구매자는 남은 구독 기간 동안만 구독권을 사용할 수 있습니다.<br><img src="38.png"></p>
<p>구매자의 구독이 취소되었다면 <code>Cancel Subscription</code>버튼이 비활성화됩니다. 이제 판매자는 <code>Refund</code> 버튼을 눌러 환불을 진행합니다.<br><img src="38-1.png"></p>
<p>구매자가 구독 취소를 이미 했다면 <code>Cancel Subscription</code> 버튼이 이미 비활성화 되어있습니다. 이 경우 판매자는 직접 구독 취소를 할 필요가 없이 <code>Refund</code> 버튼을 눌러 환불을 진행하면 됩니다.<br><img src="39.png"></p>
<p>판매자는 갱신된 결제 건 별로 환불을 진행해야합니다.<br><img src="40.png"></p>
<p>환불을 진행할 때 <code>Remove entitlement</code>에 반드시 체크합니다. 그렇지 않으면 환불은 되지만 구매자가 만료 기간까지 구독권을 사용할 수 있게 됩니다.<br><img src="42.png"></p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/ko/tags/Android/" rel="tag">Android</a> <a class="tag tag--primary tag--small t-none-link" href="/ko/tags/Payment/" rel="tag">Payment</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ko/2020/04/05/08_android/07_payment/20200405_pg/"
                    data-tooltip="[결제(Payment)] (5) VAN사, PG사, 간편결제 차이점"
                    aria-label="이전: [결제(Payment)] (5) VAN사, PG사, 간편결제 차이점"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ko/2020/04/03/08_android/07_payment/20200403_GooglePlayBilling_NonConsumableProduct/"
                    data-tooltip="[결제(Payment)] (3) 인앱 결제(Google Play Billing API) - 비소모품"
                    aria-label="다음: [결제(Payment)] (3) 인앱 결제(Google Play Billing API) - 비소모품"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 yologger. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ko/2020/04/05/08_android/07_payment/20200405_pg/"
                    data-tooltip="[결제(Payment)] (5) VAN사, PG사, 간편결제 차이점"
                    aria-label="이전: [결제(Payment)] (5) VAN사, PG사, 간편결제 차이점"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/ko/2020/04/03/08_android/07_payment/20200403_GooglePlayBilling_NonConsumableProduct/"
                    data-tooltip="[결제(Payment)] (3) 인앱 결제(Google Play Billing API) - 비소모품"
                    aria-label="다음: [결제(Payment)] (3) 인앱 결제(Google Play Billing API) - 비소모품"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                    title="Google+에 공유하기"
                    aria-label="Google+에 공유하기"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://yologger.github.io/ko/2020/04/04/08_android/07_payment/20200404_GooglePlayBilling_Subscription/"
                        aria-label="Google+에 공유하기"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Google+에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">yologger</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/ko/assets/images/background.png');"></div>
        <!--SCRIPTS-->

<script src="/ko/assets/js/script-s1qf4dycbfqqmgvjljlv3c81jri2dhkbfsbrr18gdsntpulta4iextu4bozl.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
